TOOSILA PROJECT - DATABASE ARCHITECTURE ANALYSIS
================================================

ANALYSIS COMPLETED: November 4, 2025

Generated Documentation Files:
  1. DATABASE_SUMMARY.md (3.7 KB) - Quick reference guide
  2. DATABASE_TABLES.md (7.6 KB) - Detailed table structure

KEY FINDINGS:

Database System: PostgreSQL
Query Library: pg (v8.16.3)
ORM: None (raw SQL with parameterized queries)
Connection Mode: Dual (DATABASE_URL for production, env vars for development)

TABLES (12 TOTAL):

Core Tables (10):
  1. users - User accounts (drivers/passengers)
  2. categories - City/route categories (10 Iraqi cities)
  3. demands - Passenger ride requests
  4. offers - Driver ride offers
  5. bookings - Passenger bookings on offers
  6. messages - User communication
  7. ratings - User reviews/ratings
  8. refresh_tokens - JWT authentication tokens
  9. demand_responses - Driver replies to passenger demands
  10. notifications - System notifications

Verification Tables (2):
  11. verification_documents - ID/passport documents
  12. verification_audit_log - Verification audit trail

INDEXES:
  Total: 32+ indexes
  Core Performance: 8 indexes
  Search Optimization: 13 indexes
  Advanced (Composite/Partial): 5+ indexes

MODELS (9 CLASSES):
  - User (9 methods)
  - Offer (6 methods)
  - Demand (6 methods)
  - Booking (8 methods)
  - Message (5 methods)
  - Rating (7 methods)
  - DemandResponse (8 methods)
  - Notification (8 methods)
  - VerificationDocument (7 methods)

MIGRATION SYSTEM:
  Files:
    - init-db.sql (Main schema with 12 tables, 32+ indexes, default data)
    - add-booking-seats-message.sql (Seats/message support)
    - add-id-verification.sql (ID verification system)
  
  Runners:
    - run-migration.js (Node.js executor)
    - setup-database.js (Schema initialization)
    - verify-indexes.js (Index verification)

CONNECTION CONFIGURATION:
  Production: DATABASE_URL (Railway)
  Development: Individual env vars (DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD)
  SSL: Configurable via DB_SSL
  Pool: Managed by pg library with graceful shutdown

DATA INTEGRITY:
  Foreign Keys: Cascading delete
  Unique Constraints: 4 (email, booking pair, demand_response pair, rating pair)
  Check Constraints: 6 (ratings 1-5, message length, seats 1-7, prices >= 0)
  NOT NULL: Critical fields protected

SECURITY FEATURES:
  - Parameterized queries (SQL injection prevention)
  - Password hashing (excluded from JSON)
  - Verification system for user accounts
  - Audit logging
  - Foreign key constraints

PERFORMANCE OPTIMIZATIONS:
  - Partial index on unread notifications (~200x faster)
  - Composite indexes for JOIN operations (~30x faster)
  - Descending indexes for sorting
  - Query logging with duration tracking
  - Connection pooling for efficiency

SETUP COMMANDS:
  npm run setup           # Full environment setup
  npm run db:setup       # Schema initialization only
  node scripts/verify-indexes.js  # Verify indexes

ENVIRONMENT VARIABLES:
  DB_HOST=localhost (or use DATABASE_URL in production)
  DB_PORT=5432
  DB_NAME=toosila
  DB_USER=postgres
  DB_PASSWORD=<required>
  DB_SSL=true/false

FILE STRUCTURE:
  server/config/db.js - Connection management
  server/config/env.js - Configuration
  server/models/*.js - 9 model classes
  server/scripts/init-db.sql - Schema
  server/scripts/*.sql - Migrations
  server/.env.example - Env template

ARCHITECTURE HIGHLIGHTS:
  ✓ Clean relational schema with proper normalization
  ✓ Comprehensive indexing for query performance
  ✓ Foreign key constraints for referential integrity
  ✓ Migration system for schema evolution
  ✓ Model layer provides clean API
  ✓ Supports multi-seat bookings
  ✓ ID verification system
  ✓ Audit logging for compliance

For detailed information, see:
  - DATABASE_SUMMARY.md (Quick reference)
  - DATABASE_TABLES.md (Detailed table structure)
  - server/database/migrations/README.md (Migration info)
  - server/database/migrations/README-005.md (Verification info)

Database is production-ready with good separation of concerns,
proper data validation, and performance optimization for a
ride-sharing platform.

